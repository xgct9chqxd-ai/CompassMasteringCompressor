#include "PluginEditor.h"

static void setRotary (juce::Slider& s)
{
    s.setSliderStyle (juce::Slider::RotaryHorizontalVerticalDrag);
    s.setTextBoxStyle (juce::Slider::TextBoxBelow, false, 88, 20);

    // Force visibility on dark UI (neutral, high-contrast; no "good/bad" color semantics)
    s.setColour (juce::Slider::rotarySliderOutlineColourId, juce::Colours::white.withAlpha (0.35f));
    s.setColour (juce::Slider::rotarySliderFillColourId,    juce::Colours::white.withAlpha (0.85f));
    s.setColour (juce::Slider::thumbColourId,               juce::Colours::white.withAlpha (0.90f));

    s.setColour (juce::Slider::textBoxTextColourId,         juce::Colours::white.withAlpha (0.90f));
    s.setColour (juce::Slider::textBoxOutlineColourId,      juce::Colours::white.withAlpha (0.25f));
    s.setColour (juce::Slider::textBoxBackgroundColourId,   juce::Colours::transparentBlack);
}

CompassMasteringLimiterAudioProcessorEditor::CompassMasteringLimiterAudioProcessorEditor (CompassMasteringLimiterAudioProcessor& p)
: juce::AudioProcessorEditor (&p), processor (p)
{
    setResizable (false, false);
    setSize (820, 360);

    setRotary (drive);
    addAndMakeVisible (drive);

    setRotary (ceiling);
    addAndMakeVisible (ceiling);
    adaptiveBias.addItem ("Transparent", 1);
    adaptiveBias.addItem ("Balanced", 2);
    adaptiveBias.addItem ("Aggressive", 3);
    addAndMakeVisible (adaptiveBias);

    stereoLink.setSliderStyle (juce::Slider::LinearHorizontal);
    stereoLink.setTextBoxStyle (juce::Slider::TextBoxRight, false, 90, 20);
    addAndMakeVisible (stereoLink);

    oversamplingMin.addItem ("2x", 1);
    oversamplingMin.addItem ("4x", 2);
    oversamplingMin.addItem ("8x", 3);
    addAndMakeVisible (oversamplingMin);

    addAndMakeVisible (grMeter);
    grMeter.setInterceptsMouseClicks (false, false);
    grMeter.toBack();

    currentGrLabel.setJustificationType (juce::Justification::centredRight);
    currentGrLabel.setFont (juce::Font (14.0f));
    currentGrLabel.setColour (juce::Label::textColourId, juce::Colours::white.withAlpha (0.70f));
    currentGrLabel.setColour (juce::Label::backgroundColourId, juce::Colours::transparentBlack);
    currentGrLabel.setInterceptsMouseClicks (false, false);
    currentGrLabel.setText ("GR: 0.0 dB", juce::dontSendNotification);
    addAndMakeVisible (currentGrLabel);

    inTpLabel.setJustificationType (juce::Justification::centredLeft);
    inTpLabel.setFont (juce::Font (13.0f));
    inTpLabel.setColour (juce::Label::textColourId, juce::Colours::white.withAlpha (0.70f));
    inTpLabel.setColour (juce::Label::backgroundColourId, juce::Colours::transparentBlack);
    inTpLabel.setInterceptsMouseClicks (false, false);
    inTpLabel.setText ("IN TP: -120.0 dBTP", juce::dontSendNotification);
    addAndMakeVisible (inTpLabel);

    outTpLabel.setJustificationType (juce::Justification::centredLeft);
    outTpLabel.setFont (juce::Font (13.0f));
    outTpLabel.setColour (juce::Label::textColourId, juce::Colours::white.withAlpha (0.70f));
    outTpLabel.setColour (juce::Label::backgroundColourId, juce::Colours::transparentBlack);
    outTpLabel.setInterceptsMouseClicks (false, false);
    outTpLabel.setText ("OUT TP: -120.0 dBTP", juce::dontSendNotification);
    addAndMakeVisible (outTpLabel);

    lufsSLabel.setJustificationType (juce::Justification::centredLeft);
    lufsSLabel.setFont (juce::Font (13.0f));
    lufsSLabel.setColour (juce::Label::textColourId, juce::Colours::white.withAlpha (0.70f));
    lufsSLabel.setColour (juce::Label::backgroundColourId, juce::Colours::transparentBlack);
    lufsSLabel.setInterceptsMouseClicks (false, false);
    lufsSLabel.setText ("LUFS-S: -120.0", juce::dontSendNotification);
    addAndMakeVisible (lufsSLabel);

    lufsILabel.setJustificationType (juce::Justification::centredLeft);
    lufsILabel.setFont (juce::Font (13.0f));
    lufsILabel.setColour (juce::Label::textColourId, juce::Colours::white.withAlpha (0.70f));
    lufsILabel.setColour (juce::Label::backgroundColourId, juce::Colours::transparentBlack);
    lufsILabel.setInterceptsMouseClicks (false, false);
    lufsILabel.setText ("LUFS-I: -120.0", juce::dontSendNotification);
    addAndMakeVisible (lufsILabel);

    inPeakLabel.setJustificationType (juce::Justification::centredLeft);
    inPeakLabel.setFont (juce::Font (13.0f));
    inPeakLabel.setColour (juce::Label::textColourId, juce::Colours::white.withAlpha (0.70f));
    inPeakLabel.setColour (juce::Label::backgroundColourId, juce::Colours::transparentBlack);
    inPeakLabel.setInterceptsMouseClicks (false, false);
    inPeakLabel.setText ("IN PEAK: -120.0 dBFS", juce::dontSendNotification);
    addAndMakeVisible (inPeakLabel);

    outPeakLabel.setJustificationType (juce::Justification::centredLeft);
    outPeakLabel.setFont (juce::Font (13.0f));
    outPeakLabel.setColour (juce::Label::textColourId, juce::Colours::white.withAlpha (0.70f));
    outPeakLabel.setColour (juce::Label::backgroundColourId, juce::Colours::transparentBlack);
    outPeakLabel.setInterceptsMouseClicks (false, false);
    outPeakLabel.setText ("OUT PEAK: -120.0 dBFS", juce::dontSendNotification);
    addAndMakeVisible (outPeakLabel);

    ceilingLabel.setJustificationType (juce::Justification::centredLeft);
    ceilingLabel.setFont (juce::Font (13.0f));
    ceilingLabel.setColour (juce::Label::textColourId, juce::Colours::white.withAlpha (0.70f));
    ceilingLabel.setColour (juce::Label::backgroundColourId, juce::Colours::transparentBlack);
    ceilingLabel.setInterceptsMouseClicks (false, false);
    ceilingLabel.setText ("CEILING: -1.0 dBTP", juce::dontSendNotification);
    addAndMakeVisible (ceilingLabel);

    auto& vts = processor.getAPVTS();

    driveA   = std::make_unique<APVTS::SliderAttachment> (vts, "drive", drive);
    ceilingA = std::make_unique<APVTS::SliderAttachment> (vts, "ceiling", ceiling);
    biasA    = std::make_unique<APVTS::ComboBoxAttachment> (vts, "adaptive_bias", adaptiveBias);
    linkA    = std::make_unique<APVTS::SliderAttachment> (vts, "stereo_link", stereoLink);
    osA      = std::make_unique<APVTS::ComboBoxAttachment> (vts, "oversampling_min", oversamplingMin);

    startTimerHz (30);
}

void CompassMasteringLimiterAudioProcessorEditor::timerCallback()
{
    const float current = processor.getCurrentGRDb();

    grMeter.pushValueDb (current);
    currentGrLabel.setText (juce::String::formatted ("GR: %.1f dB", current), juce::dontSendNotification);

    float inTp = -120.0f;
    float outTp = -120.0f;
    if (processor.getCurrentTruePeakDbTP (inTp, outTp))
    {
        inTp = juce::jmax (-120.0f, inTp);
        outTp = juce::jmax (-120.0f, outTp);
        inTpLabel.setText (juce::String::formatted ("IN TP: %.1f dBTP", inTp), juce::dontSendNotification);
        outTpLabel.setText (juce::String::formatted ("OUT TP: %.1f dBTP", outTp), juce::dontSendNotification);
    }

    float lufsS = -120.0f;
    float lufsI = -120.0f;
    if (processor.getCurrentLufsDb (lufsS, lufsI))
    {
        lufsS = juce::jmax (-120.0f, lufsS);
        lufsI = juce::jmax (-120.0f, lufsI);
        lufsSLabel.setText (juce::String::formatted ("LUFS-S: %.1f", lufsS), juce::dontSendNotification);
        lufsILabel.setText (juce::String::formatted ("LUFS-I: %.1f", lufsI), juce::dontSendNotification);
    }

    float inPk = -120.0f;
    float outPk = -120.0f;
    if (processor.getCurrentPeakDbFS (inPk, outPk))
    {
        inPk = juce::jmax (-120.0f, inPk);
        outPk = juce::jmax (-120.0f, outPk);
        inPeakLabel.setText (juce::String::formatted ("IN PEAK: %.1f dBFS", inPk), juce::dontSendNotification);
        outPeakLabel.setText (juce::String::formatted ("OUT PEAK: %.1f dBFS", outPk), juce::dontSendNotification);
    }

    const float ceilDb = processor.getCurrentCeilingDbTP();
    ceilingLabel.setText (juce::String::formatted ("CEILING: %.1f dBTP", ceilDb), juce::dontSendNotification);

    grMeter.repaint();
}

void CompassMasteringLimiterAudioProcessorEditor::paint (juce::Graphics& g)
{
    g.fillAll (juce::Colours::black);

    // Title
    g.setColour (juce::Colours::white.withAlpha (0.85f));
    g.setFont (14.0f);
    g.drawText ("Compass Mastering Limiter", 16, 10, getWidth() - 32, 20, juce::Justification::left);

    // Static labels (constitution: labeling for all visible controls)
    auto drawLabelAbove = [&] (const juce::Component& c, const juce::String& label)
    {
        auto r = c.getBounds().translated (0, -18);
        r.setHeight (16);
        g.setColour (juce::Colours::white.withAlpha (0.70f));
        g.setFont (12.5f);
        g.drawText (label, r, juce::Justification::centred, false);
    };

    drawLabelAbove (drive,           "Drive");
    drawLabelAbove (ceiling,         "Ceiling");
    drawLabelAbove (adaptiveBias,    "Adaptive Bias");
    drawLabelAbove (stereoLink,      "Stereo Link");
    drawLabelAbove (oversamplingMin, "Oversampling Min");
}

void CompassMasteringLimiterAudioProcessorEditor::resized()
{
    auto b = getLocalBounds().reduced (16);
    b.removeFromTop (30);

    const int knob = 104;
    const int gap  = 16;

    auto row = b.removeFromTop (knob + 30);

    drive.setBounds (row.removeFromLeft (knob));
    row.removeFromLeft (gap);
    ceiling.setBounds (row.removeFromLeft (knob));
    row.removeFromLeft (gap);

    adaptiveBias.setBounds (row.removeFromLeft (260).withTrimmedTop (34).withHeight (26));
    row.removeFromLeft (gap);
    stereoLink.setBounds (row.removeFromLeft (260).withTrimmedTop (34).withHeight (26));
    row.removeFromLeft (gap);
    oversamplingMin.setBounds (row.removeFromLeft (100).withTrimmedTop (34).withHeight (26));

    b.removeFromTop (10);

    // Primary meter zone (Verification): GR bar + numeric, then truth readouts below.
    grMeter.setBounds (b.removeFromTop (40));

    auto m = grMeter.getBounds();

    // GR numeric (right side of the bar zone)
    currentGrLabel.setBounds (m.getRight() - 90, m.getY() + 6, 84, 18);

    // Truth readouts grid (Bottom row concept, placed under the bar inside meter zone)
    const int colW   = 220;
    const int padX   = 10;
    const int rowH   = 18;
    const int rowGap = 6;

    const int leftX  = m.getX() + padX;
    const int rightX = m.getRight() - colW - padX;

    const int y1 = m.getY() + 50;                 // Row 1 start (below bar)
    const int y2 = y1 + rowH + rowGap;            // Row 2
    const int y3 = y2 + rowH + rowGap;            // Row 3
    const int y4 = y3 + rowH + rowGap;            // Row 4 (Ceiling)

    // Row 1: IN/OUT TP
    inTpLabel.setBounds  (leftX,  y1, colW, rowH);
    outTpLabel.setBounds (rightX, y1, colW, rowH);

    // Row 2: LUFS-S / LUFS-I
    lufsSLabel.setBounds (leftX,  y2, colW, rowH);
    lufsILabel.setBounds (rightX, y2, colW, rowH);

    // Row 3 (optional utilities): IN/OUT PEAK
    inPeakLabel.setBounds  (leftX,  y3, colW, rowH);
    outPeakLabel.setBounds (rightX, y3, colW, rowH);

    // Tuck CEILING near the utilities (still numeric-only)
    ceilingLabel.setBounds (m.getX() + padX, y4, m.getWidth() - (2 * padX), rowH);
}
